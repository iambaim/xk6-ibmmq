services:
  init-pki:
    image: icr.io/ibm-messaging/mq:9.4.1.0-r1
    command: >
      bash -c "/opt/mqm/bin/runmqakm -keydb -create -db /etc/mqm/pki/myqmgr.kdb -type cms -stash -pw password
      && /opt/mqm/bin/runmqakm -cert -create -db /etc/mqm/pki/myqmgr.kdb -stashed -label ibmwebspheremqqm1 -dn "CN=localhost,O=myOrganisation,OU=myDepartment,L=myLocation,C=NO" -sig_alg SHA384WithRSA
      && /opt/mqm/bin/runmqakm -cert -extract -db /etc/mqm/pki/myqmgr.kdb -stashed -label ibmwebspheremqqm1 -target /etc/mqm/pki/tls.crt -format ascii
      && /opt/mqm/bin/runmqakm -cert -export -db /etc/mqm/pki/myqmgr.kdb -stashed -label ibmwebspheremqqm1 -type cms -target /etc/mqm/pki/myqmgr2.p12 -target_stashed -target_type pkcs12
      && openssl pkcs12 -in /etc/mqm/pki/myqmgr2.p12 -nodes -nocerts -passin pass:password | openssl pkcs8 -nocrypt -out /etc/mqm/pki/tls.key 
      && mkdir -p /etc/mqm/pki/keys/ibmwebspheremqqm1
      && mv /etc/mqm/pki/tls.* /etc/mqm/pki/keys/ibmwebspheremqqm1"
    volumes:
      - pki:/etc/mqm/pki
  qm:
    image: icr.io/ibm-messaging/mq:9.4.1.0-r1
    ports:
      - "1414:1414"
    environment:
      - LICENSE=accept
      - MQ_QMGR_NAME=QM1
      - MQ_ADMIN_PASSWORD=password
      - MQ_APP_PASSWORD=password
    volumes:
      - pki:/etc/mqm/pki
    depends_on:
      init-pki:
        condition: service_completed_successfully
  k6:
    build:
      context: ../
    environment:
      - MQ_QMGR="QM1"-
      - MQ_CHANNEL="DEV.APP.SVRCONN"
      - MQ_HOST="qm"
      - MQ_PORT=1414
      - MQ_USERID="app"
      - MQ_PASSWORD="password"
      - MQ_TLS_KEYSTORE=/etc/mqm/pki/myqmgr
    volumes:
      - pki:/etc/mqm/pki
    depends_on:
      qm:
        condition: service_started
volumes:
  pki: